<!DOCTYPE html><html><head><title>OPC5 emulator</title>
<script>
var op = {"ld":0x8,  "ld.i":0,  "add":0x9, "add.i":1, "and":0xA, "and.i":2, "or":0xB,  "or.i":0x3,
          "xor":0xC, "xor.i":4, "ror":0xD, "ror.i":5, "sub":0xE, "sub.i":6, "sto":0x7, "halt" :0x0 }
var mem = new Uint16Array(2048), pad="                             ";
function hex(n) {return ((1 << 16 | n).toString(16).substr(-4));}
function init(){
    mem.set(eval('['+location.search.replace(/.d=/,'').replace(/([0-9a-f]{4})/ig,'0x$1,')+']'));
    document.getElementById("RAM").innerHTML=[].slice.call(mem.slice(0x0,0x100)).
        map(function(x){return hex(x)});
}
function load(){
    mem.set(eval("[0x" + document.getElementById("RAM").value.replace(/,/g,",0x")+"]"));
}
function boot() {
    var maxcycles=999, cycle=0, pcreg=15, regfile=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0], c=0, z=0;
    while (cycle < maxcycles){
        pc=regfile[pcreg]; regfile[0] = 0; // fixup special registers
        iword = mem[pc];
        [pcarry,pnzero] = [(iword & 0x8000) >> 15, (iword & 0x4000) >> 14];
        [opcode,ilen]   = [(iword & 0x1E00) >> 9,  (iword & 0x2000) ? 2 : 1];
        [source,dest]   = [(iword & 0xF0) >> 4,    iword & 0xF];
        operand = (ilen==2) ? mem[pc+1] : 0;

        istr = {0:"cnz.", 1:"c.", 2:"nz.", 3:""}[(pcarry << 1) | pnzero];
        istr += Object.keys(op)[Object.values(op).indexOf(opcode)]+" r"+dest+",r"+source;
        istr += (ilen==2) ? ",0x" + hex(operand) : "";
        if (opcode==op["ld.i"] && dest==0 && source==0){ istr=istr.replace("ld.i","halt"); }

        document.getElementById("log").innerHTML += [(pad+cycle).slice(-5),":",hex(pc),":",
            hex(mem[pc]),(ilen==2)?hex(mem[pc+1]):"    ",":",c,z,":",
            (istr + pad).slice(0,24),":",regfile.map(function(x){return hex(x)}).join(" "),
            "\n"].join(" ");

        regfile[15] += ilen; cycle++;
        ea_ed = regfile[source] + operand; if (iword & 0x1000) { ea_ed = mem[ea_ed]; }
        if ( (pcarry || c) && (pnzero || !z) ){
            if ( opcode==op["halt"] && source==0 && dest==0){ break; }
            if ( opcode==op["and.i"] || opcode==op["and"] ){
                regfile[dest] = regfile[dest] & ea_ed;
            } else if ( opcode==op["or.i"] || opcode==op["or"] ){
                regfile[dest] = regfile[dest] | ea_ed;
            } else if ( opcode==op["xor.i"] || opcode==op["xor"] ){
                regfile[dest] = regfile[dest] ^ ea_ed;
            } else if ( opcode==op["ror.i"] || opcode==op["ror"] ){
                c = 1 & ea_ed; regfile[dest] = (c<<15) | (ea_ed>>1);
            } else if ( [op["add.i"], op["add"], op["sub.i"], op["sub"]].indexOf(opcode)>=0 ){
                res = regfile[dest] + ((opcode==op["add.i"] || opcode==op["add"]) ? ea_ed : -ea_ed);
                regfile[dest] = res & 0xFFFF; c = (res>>16) & 1;
            } else if ( opcode==op["ld.i"] || opcode==op["ld"] ){
                regfile[dest] = ea_ed;
            } else if ( opcode == op["sto"] ){
                mem[ea_ed] = regfile[dest];
            }
            if ( opcode != op["sto"] ){ z = (regfile[dest]==0) ? 1 : 0; }
        }
    }
    document.getElementById("log").innerHTML += "Done!\n";
}
</script></head><body onload="init()">Welcome to the <a href=".">OPC</a> in-browser Emulator
<p>Memory: <button type="button" onclick="load()">Load RAM</button>
<p><textarea rows="4" cols="80" id=RAM>JavaScript disabled!</textarea>
<p><button type="button" onclick="boot()">Boot</button><pre id=log>
Cycle : PC   : Mem       : C Z : Instruction              : Registers
-------------------------------------------------------------------------------------
</pre></body></html>

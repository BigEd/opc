<!DOCTYPE html><html><head><title>OPC5 emulator</title>
<script>
var dis = "mov,and,or,xor,add,adc,sto,ld,ror,not,sub,sbc,cmp,cmpc,bswp,int,halt".split(',');
var mem = new Uint16Array(2048), pad="                             ";
function hex(n) {return ((1 << 16 | n).toString(16).substr(-4));}
function init(){
    mem.set(eval('['+location.search.replace(/.d=/,'').replace(/([0-9a-f]{4})/ig,'0x$1,')+']'));
    document.getElementById("RAM").innerHTML=[].slice.call(mem.slice(0x0,0x100)).
        map(function(x){return hex(x)});
}
function load(){
    mem.set(eval("[0x" + document.getElementById("RAM").value.replace(/,/g,",0x")+"]"));
}
function boot() {
    var max=70123, cycle=0, regs=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0], c=0, z=0, log="", stdout="";
    while (cycle < max){
        pc=regs[15]; regs[0] = 0; // fixup special registers
        iword = mem[pc];
        [cp,zp,pi]    = [(iword & 0x8000) >> 15,    (iword & 0x4000) >> 14, (iword & 0x2000)>>13];
        [opcode,ilen] = [dis[(iword & 0xF00) >> 8], (iword & 0x1000) ? 2 : 1];
        [source,dest] = [(iword & 0xF0) >> 4,       iword & 0xF];
        operand = (ilen==2) ? mem[pc+1] : 0;
        istr = ["cz.", "ncz", "c.", "nc.", "z.", "nz.", "", "0."][(cp << 2) | (zp << 1) | pi];
        istr += opcode+" r"+dest+",r"+source;
        istr += (ilen==2) ? ",0x" + hex(operand) : "";
        log += [(pad+cycle).slice(-5),":",hex(pc),":", hex(mem[pc]),(ilen==2)?hex(mem[pc+1]):"    ",
            ":",c,z,":",(istr + pad).slice(0,24),":",regs.map(function(x){return hex(x)}).join(" "),
            "\n"].join(" ");
        regs[15] += ilen; cycle++;
        ea_ed = (regs[source] + operand) & 0xFFFF; if (opcode=="ld") { ea_ed = mem[ea_ed]; }
        if ( pi ^ ((cp || c) && (zp || z)) ){
            if ( opcode=="mov" && source==0 && dest==0){ break; }
            if ( opcode=="and" ){
                regs[dest] = regs[dest] & ea_ed;
            } else if ( opcode=="or" ){
                regs[dest] = regs[dest] | ea_ed;
            } else if ( opcode=="xor" ){
                regs[dest] = regs[dest] ^ ea_ed;
            } else if ( opcode=="ror" ){
                regs[dest] = (c<<15) | (ea_ed>>1); c = 1 & ea_ed;
            } else if ( opcode=="bswp" ){
                regs[dest] = (ea_ed >> 8)|(ea_ed << 8);
            } else if ( opcode=="add" || opcode=="adc" ){
                res = regs[dest] + ea_ed + (opcode=="adc" ? c : 0);
                regs[dest] = res & 0xFFFF; c = (res>>16) & 1;
            } else if ( ["sub","sbc","cmp","cmpc"].indexOf(opcode)>=0 ){
                res = regs[dest] + ((~ea_ed & 0xffff)) + (/c$/.test(opcode) ? c : 1);
                if(/^c/.test(opcode)){ dest=0; }
                regs[dest] = res & 0xFFFF; c = (res>>16) & 1;
            } else if ( opcode=="ld" || opcode=="mov" || opcode=="not"){
                opcode=="not" ? regs[dest] = ~ea_ed : regs[dest] = ea_ed;
            } else if ( opcode=="sto" ){
                mem[ea_ed] = regs[dest];
                if (ea_ed == 0xfe09){stdout += String.fromCharCode(regs[dest]); log += stdout+"\n"}
            }
            if ( opcode!="sto" ){ z = (regs[dest]==0) ? 1 : 0; }
    }   }
    document.getElementById("printout").innerHTML = log + "Done!\n";
}
</script></head><body onload="init()">Welcome to the <a href=".">OPC</a> in-browser Emulator
<p>Memory: <button type="button" onclick="load()">Load RAM</button>
<p><textarea rows="4" cols="80" id=RAM>JavaScript disabled!</textarea>
<p><button type="button" onclick="boot()">Boot</button><pre id=printout>
Cycle : PC   : Mem       : C Z : Instruction              : Registers
-------------------------------------------------------------------------------------
</pre></body></html>
